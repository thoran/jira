#!/usr/bin/env ruby
# jira

# 20221024
# 0.2.1

# Changes since 0.1:
# 1. /sub_domain/subdomain/
# 2. + config() (Reintroduced and altered from 0.0.0.)
# 3. ~ subdomain(): + use of config().
# 0/1
# 4. ~ jira_issue_id(): Account for when the next character after the issue id is either an underscore or a hyphen.

gem 'git.rb'
require 'Git/Branch'

def config
  eval(File.read(File.expand_path('~/.config/jira.rb')))
  {subdomain: SUBDOMAIN}
end

def subdomain
  config[:subdomain] || ARGV[0]
end

def current_branch_name
  Git::Branch.current.name
end

def jira_issue_id
  if md = current_branch_name.match(/^(.+-\d+)[-_]/)
    md[1]
  end
end

def jira_url
  "https://#{subdomain}.atlassian.net/browse/#{jira_issue_id}"
end

def main
  system("open #{jira_url}")
end

main
